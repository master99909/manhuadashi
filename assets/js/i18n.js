const translations = {
    "zh-CN": {
        "title": "漫画大师 - 极致本地阅读体验",
        "nav_features": "功能特性",
        "nav_download": "立即下载",
        "nav_agreement": "用户协议",
        "nav_privacy": "隐私政策",
        "hero_title": "漫画大师  本地阅读首选",
        "hero_subtitle": "专为漫画爱好者打造。支持 AI 翻译、画质增强、多格式直读。你的私人漫画图书馆。",
        "btn_download": "App Store 下载",
        "btn_learn_more": "了解更多",
        "feat_local_title": "全格式支持",
        "feat_local_desc": "无缝读取 EPUB, PDF, CBZ, CBR, ZIP, RAR, 7Z 等格式。无需转码，直接打开。",
        "feat_ai_title": "AI 实时翻译",
        "feat_ai_desc": "打破语言障碍。内置多种 AI 翻译引擎，实时将外文漫画翻译成母语。",
        "feat_enhance_title": "画质增强",
        "feat_enhance_desc": "利用先进的 AI 算法，将低清老漫画智能修复为高清大图。",
        "feat_stats_title": "阅读统计",
        "feat_stats_desc": "详细的阅读时长、热力图和进度管理，记录你的每一次阅读旅程。",
        "download_title": "开始你的阅读之旅",
        "download_desc": "立即体验最强大的本地漫画阅读器。",
        "footer_copyright": "© 2026 漫画大师. 保留所有权利。",
        "folder_name": "简体",
        "feat_custom_title": "个性化定制",
        "feat_custom_desc": "支持自定义 APP 背景图、背景色、导航栏颜色及文字颜色，打造专属阅读空间。",
        "feat_lock_title": "隐私保护",
        "feat_lock_desc": "支持 APP 加锁功能，FaceID/TouchID 解锁，确保漫画内容安全私密。",
        "feat_sync_title": "云端同步",
        "feat_sync_desc": "支持 iCloud 云同步功能，多设备间无缝切换，阅读进度自动同步。",
        "feat_folder_title": "多级分类",
        "feat_folder_desc": "支持创建多级文件夹与分类，自由定义分组，轻松管理海量漫画。",
        "feat_shelf_title": "书架布局",
        "feat_shelf_desc": "支持多种书架样式排版，列表、网格、瀑布流随心切换。"
    },
    "zh-TW": {
        "title": "漫畫大師 - 極致本地閱讀體驗",
        "nav_features": "功能特性",
        "nav_download": "立即下載",
        "nav_agreement": "用戶協議",
        "nav_privacy": "隱私政策",
        "hero_title": "漫畫大師  本地閱讀首選",
        "hero_subtitle": "專為漫畫愛好者打造。支持 AI 翻譯、畫質增強、多格式直讀。你的私人漫畫圖書館。",
        "btn_download": "App Store 下載",
        "btn_learn_more": "了解更多",
        "feat_local_title": "全格式支持",
        "feat_local_desc": "無縫讀取 EPUB, PDF, CBZ, CBR, ZIP, RAR, 7Z 等格式。無需轉碼，直接打開。",
        "feat_ai_title": "AI 實時翻譯",
        "feat_ai_desc": "打破語言障礙。內置多種 AI 翻譯引擎，實時將外文漫畫翻譯成母語。",
        "feat_enhance_title": "畫質增強",
        "feat_enhance_desc": "利用先進的 AI 算法，將低清老漫畫智能修復為高清大圖。",
        "feat_stats_title": "閱讀統計",
        "feat_stats_desc": "詳細的閱讀時長、熱力圖和進度管理，記錄你的每一次閱讀旅程。",
        "download_title": "開始你的閱讀之旅",
        "download_desc": "立即體驗最強大的本地漫畫閱讀器。",
        "footer_copyright": "© 2026 漫畫大師. 保留所有權利。",
        "folder_name": "繁体",
        "feat_custom_title": "個性化定制",
        "feat_custom_desc": "支持自定義 APP 背景圖、背景色、導航欄顏色及文字顏色，打造專屬閱讀空間。",
        "feat_lock_title": "隱私保護",
        "feat_lock_desc": "支持 APP 加鎖功能，FaceID/TouchID 解鎖，確保漫畫內容安全私密。",
        "feat_sync_title": "雲端同步",
        "feat_sync_desc": "支持 iCloud 雲同步功能，多設備間無縫切換，閱讀進度自動同步。",
        "feat_folder_title": "多級分類",
        "feat_folder_desc": "支持創建多級文件夾與分類，自由定義分組，輕鬆管理海量漫畫。",
        "feat_shelf_title": "書架佈局",
        "feat_shelf_desc": "支持多種書架樣式排版，列表、網格、瀑布流隨心切換。"
    },
    "en": {
        "title": "Manga Master - Ultimate Local Reader",
        "nav_features": "Features",
        "nav_download": "Download",
        "nav_agreement": "Terms",
        "nav_privacy": "Privacy",
        "hero_title": "Manga Master",
        "hero_subtitle": "The ultimate local manga reader. AI Translation, Image Enhancement, and Multi-format support.",
        "btn_download": "Download on App Store",
        "btn_learn_more": "Learn More",
        "feat_local_title": "Format Support",
        "feat_local_desc": "Reads EPUB, PDF, CBZ, CBR, ZIP, RAR, 7Z directly. No conversion needed.",
        "feat_ai_title": "AI Translation",
        "feat_ai_desc": "Translate manga in real-time using advanced AI engines. Break language barriers.",
        "feat_enhance_title": "Image Upscaling",
        "feat_enhance_desc": "Restore and upscale old, low-res manga to HD quality using on-device AI.",
        "feat_stats_title": "Reading Stats",
        "feat_stats_desc": "Track your reading habits with detailed heatmaps, duration logs, and progress.",
        "download_title": "Start Reading Today",
        "download_desc": "Experience the best local manga reader available.",
        "footer_copyright": "© 2026 Manga Master. All rights reserved.",
        "folder_name": "英语",
        "feat_custom_title": "Personalization",
        "feat_custom_desc": "Customize app background, colors, and fonts to create your unique reading space.",
        "feat_lock_title": "App Lock",
        "feat_lock_desc": "Secure your content with FaceID/TouchID protection for complete privacy.",
        "feat_sync_title": "Cloud Sync",
        "feat_sync_desc": "Seamless iCloud sync keeps your reading progress up to date across all devices.",
        "feat_folder_title": "Multi-level Folders",
        "feat_folder_desc": "Organize your collection with nested folders and custom categories.",
        "feat_shelf_title": "Bookshelf Layouts",
        "feat_shelf_desc": "Choose from Grid, List, or Waterfall layouts to display your library your way."
    },
    "ja": {
        "title": "漫画マスター - 究極のローカルリーダー",
        "nav_features": "機能",
        "nav_download": "ダウンロード",
        "nav_agreement": "利用規約",
        "nav_privacy": "プライバシー",
        "hero_title": "漫画マスター",
        "hero_subtitle": "究極のローカル漫画リーダー。AI翻訳、高画質化、多形式対応。",
        "btn_download": "App Store からダウンロード",
        "btn_learn_more": "詳細を見る",
        "feat_local_title": "多形式対応",
        "feat_local_desc": "EPUB, PDF, CBZ, CBR, ZIP, RAR, 7Z を直接読み込み可能。変換不要。",
        "feat_ai_title": "AI翻訳",
        "feat_ai_desc": "高度なAIエンジンを使用してリアルタイムで翻訳。言葉の壁を越えよう。",
        "feat_enhance_title": "高画質化",
        "feat_enhance_desc": "AIアルゴリズムで低解像度の古い漫画をHD画質に修復。",
        "feat_stats_title": "読書統計",
        "feat_stats_desc": "詳細なヒートマップ、時間記録、進捗管理で読書習慣を追跡。",
        "download_title": "今すぐ始めよう",
        "download_desc": "最高のローカル漫画リーダーを体験してください。",
        "footer_copyright": "© 2026 Manga Master. All rights reserved.",
        "folder_name": "日语",
        "feat_custom_title": "カスタマイズ",
        "feat_custom_desc": "アプリの背景、色、テーマを自由にカスタマイズ。あなただけの読書空間を。",
        "feat_lock_title": "アプリロック",
        "feat_lock_desc": "FaceID/TouchID ロックでプライバシーを保護。安心して楽しめます。",
        "feat_sync_title": "クラウド同期",
        "feat_sync_desc": "iCloud 同期対応。複数のデバイス間で読書の進捗をシームレスに同期。",
        "feat_folder_title": "多層フォルダ",
        "feat_folder_desc": "多階層のフォルダとカスタム分類で、膨大なコレクションもすっきり整理。",
        "feat_shelf_title": "本棚レイアウト",
        "feat_shelf_desc": "グリッド、リスト、ウォーターフォールなど、好みのレイアウトに切り替え可能。"
    },
    "ko": {
        "title": "만화 마스터 - 최고의 로컬 리더",
        "nav_features": "기능",
        "nav_download": "다운로드",
        "nav_agreement": "이용 약관",
        "nav_privacy": "개인정보 처리방침",
        "hero_title": "만화 마스터",
        "hero_subtitle": "궁극의 로컬 만화 리더. AI 번역, 화질 개선, 다양한 포맷 지원.",
        "btn_download": "App Store 에서 다운로드",
        "btn_learn_more": "더 알아보기",
        "feat_local_title": "다양한 포맷",
        "feat_local_desc": "EPUB, PDF, CBZ, CBR, ZIP, RAR, 7Z 등 완벽 지원. 변환 없이 바로 감상.",
        "feat_ai_title": "AI 번역",
        "feat_ai_desc": "고급 AI 엔진을 통한 실시간 만화 번역. 언어 장벽 없이 즐기세요.",
        "feat_enhance_title": "화질 개선",
        "feat_enhance_desc": "AI 알고리즘을 사용하여 저화질의 옛날 만화를 HD 화질로 복원.",
        "feat_stats_title": "독서 통계",
        "feat_stats_desc": "히트맵, 독서 시간, 진행 상황 등 상세한 통계 기능 제공.",
        "download_title": "지금 시작하세요",
        "download_desc": "최고의 로컬 만화 리더를 경험해보세요.",
        "footer_copyright": "© 2026 Manga Master. All rights reserved.",
        "folder_name": "韩语",
        "feat_custom_title": "개인화 설정",
        "feat_custom_desc": "배경화면, 테마 색상, 폰트 등을 자유롭게 설정하여 나만의 앱을 만드세요.",
        "feat_lock_title": "앱 잠금",
        "feat_lock_desc": "FaceID/TouchID 잠금 기능으로 개인 정보를 안전하게 보호하세요.",
        "feat_sync_title": "클라우드 동기화",
        "feat_sync_desc": "iCloud 동기화를 통해 모든 기기에서 독서 진행 상황을 읭어보세요.",
        "feat_folder_title": "폴더 관리",
        "feat_folder_desc": "다단계 폴더와 사용자 정의 분류로 방대한 만화를 체계적으로 정리하세요.",
        "feat_shelf_title": "서재 레이아웃",
        "feat_shelf_desc": "그리드, 리스트, 폭포수 등 다양한 서재 뷰 모드를 지원합니다."
    }
};

function detectLanguage() {
    const savedLang = localStorage.getItem('site-lang');
    if (savedLang && translations[savedLang]) {
        return savedLang;
    }

    const navLang = navigator.language || navigator.userLanguage;

    // Check exact match first
    if (translations[navLang]) return navLang;

    // Check primary code (e.g. 'zh' from 'zh-SG')
    const primaryLang = navLang.split('-')[0];

    if (primaryLang === 'zh') {
        // Default to Simplified for zh unless TW/HK/MO
        if (navLang.includes('TW') || navLang.includes('HK') || navLang.includes('MO')) {
            return 'zh-TW';
        }
        return 'zh-CN';
    }

    if (primaryLang === 'ja') return 'ja';
    if (primaryLang === 'ko') return 'ko';

    return 'en';
}

function updateContent(lang) {
    const t = translations[lang];

    // Update Text
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });

    // Update Title
    document.title = t['title'];

    // Update Carousel
    updateCarousel(t['folder_name'], t['title']);

    // Save preference
    localStorage.setItem('site-lang', lang);

    // Update Active State in Dropdown
    document.querySelectorAll('.lang-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.dataset.lang === lang) opt.classList.add('active');
    });
}

function updateCarousel(folderName, altTitle) {
    const track = document.getElementById('carousel-track');
    const nav = document.getElementById('carousel-nav');
    const scrollArea = document.getElementById('carousel-scroll-area');

    if (!track || !nav || !scrollArea) return;

    // Clear existing
    track.innerHTML = '';
    nav.innerHTML = '';

    const count = 8; // We verified all folders have 8 images

    for (let i = 1; i <= count; i++) {
        // Create Slide
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';

        const img = document.createElement('img');
        // Encode URL components just in case, though folderName is safe usually
        // Use GitHub raw content for images
        const encodedFolder = encodeURIComponent(folderName);
        const filename = `Apple iPhone 16 Pro Max Screenshot ${i}.png`;
        const encodedFilename = encodeURIComponent(filename);
        img.src = `https://raw.githubusercontent.com/master99909/manhuadashi/main/${encodedFolder}/${encodedFilename}`;
        img.alt = `${altTitle} Screenshot ${i}`;
        img.loading = i > 1 ? 'lazy' : 'eager'; // Lazy load non-visible images

        slide.appendChild(img);
        track.appendChild(slide);

        // Create Dot
        const dot = document.createElement('div');
        dot.className = i === 1 ? 'carousel-dot active' : 'carousel-dot';
        dot.dataset.index = i - 1;

        dot.addEventListener('click', () => {
            const width = scrollArea.clientWidth; // or slide.offsetWidth
            scrollArea.scrollTo({
                left: width * (i - 1),
                behavior: 'smooth'
            });
        });

        nav.appendChild(dot);
    }

    // Reset Scroll
    scrollArea.scrollLeft = 0;

    // Update active dot on scroll
    scrollArea.onscroll = () => {
        const width = scrollArea.clientWidth; // Assume 1 slide per view
        const index = Math.round(scrollArea.scrollLeft / width);

        document.querySelectorAll('.carousel-dot').forEach((d, idx) => {
            if (idx === index) d.classList.add('active');
            else d.classList.remove('active');
        });
    };
}

document.addEventListener('DOMContentLoaded', () => {
    let currentLang = detectLanguage();
    updateContent(currentLang);

    // Language Selector Logic
    const langBtn = document.getElementById('lang-btn');
    const langDropdown = document.getElementById('lang-dropdown');

    if (langBtn && langDropdown) {
        langBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            langDropdown.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            langDropdown.classList.remove('active');
        });

        document.querySelectorAll('.lang-option').forEach(opt => {
            opt.addEventListener('click', () => {
                const lang = opt.dataset.lang;
                updateContent(lang);
            });
        });
    }
});
